<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="beta.function.order.dao.CartMapper">

    <!-- game_cart와 game_list 테이블 -->
    <resultMap id="cartGameResultMap" type="beta.function.order.dto.CartDTO">
        <id property="cartCode" column="cartCode"/>
        <result property="userCode" column="userCode"/>
        <result property="gameCode" column="gameCode"/>
        <!--game_cart 테이블과 game_list 테이블 join-->
        <collection property="gameDTO" resultMap="gameResultMap"/>
    </resultMap>

    <!--game_list 테이블-->
    <resultMap id="gameResultMap" type="beta.function.game.dto.GameDTO">
        <result property="gameName" column="gameName"/>
        <result property="gamePrice" column="gamePrice"/>
        <result property="gameThumbnail" column="gameThumbnail"/>
    </resultMap>

    <!-- account_list와 game_cart 테이블 -->
    <resultMap id="userCartResultMap" type="beta.function.account.dto.AccountDTO">
        <id property="userCode" column="userCode"/>
        <result property="userCode" column="userCode"/>
        <result property="gameCode" column="gameCode"/>
        <!-- aaccount_list 테이블과 game_cart 테이블 join -->
        <collection property="cartDTO" resultMap="cartResultMap"/>
    </resultMap>

    <!-- account_list 테이블 -->
    <resultMap id="cartResultMap" type="beta.function.order.dto.CartDTO">
        <result property="gameCode" column="gameCode"/>
    </resultMap>

    <!--장바구니 리스트-->
    <select id="findAllList" resultMap="cartGameResultMap">
        SELECT
            a.cartCode,
            a.userCode,
            b.gameCode,
            b.gameName,
            b.gamePrice,
            b.gameThumbnail
        FROM
            game_cart a
        JOIN game_list b ON a.gameCode = b.gameCode
    </select>

    <!--회원별 장바구니 리스트-->
    <select id="findByUser" resultMap="cartGameResultMap">
        SELECT
            a.cartCode,
            a.userCode,
            b.gameCode,
            b.gameName,
            b.gamePrice,
            b.gameThumbnail,
            c.gamecheck,
            a.addCart
        FROM
            game_cart a
        <!--게임 리스트 목록에서 아이템을 담는 조인문-->
        JOIN game_list b ON a.gameCode = b.gameCode
        <!--장바구니에서 결제시 결제여부 체크 조인문-->
        join game_order c on a.userCode = c.userCode
        WHERE
            a.userCode = #{ userCode } AND c.gamecheck = 'N' AND a.addCart = 'Y';
    </select>

    <!--동일한 게임이 있는지 확인-->
<!--    <select id="findItemByGameAndUser" parameterType="beta.function.order.dto.CartDTO" resultType="beta.function.order.dto.CartDTO">-->
<!--        SELECT-->
<!--        cartCode, userCode, gameCode-->
<!--        FROM-->
<!--        game_cart-->
<!--        WHERE-->
<!--        userCode = #{userCode}-->
<!--        AND gameCode = #{gameCode}-->
<!--    </select>-->

    <!--게임 총 금액-->
    <select id="gamePriceTotal" parameterType="beta.function.order.dto.CartDTO">
        SELECT
        SUM(gamePrice) as total
        FROM
        game_cart a
        JOIN game_list b ON a.gameCode = b.gameCode
    </select>

    <!--장바구니 담기 전 장바구니 체크-->
    <select id="cartListCheck" parameterType="beta.function.order.dto.CartDTO">
        select
            count(gc.gameCode)
        from game_cart gc
        where gc.gameCode = #{ gameCode } and userCode = 2
    </select>


    <!--장바구니에 담기-->
    <insert id="addItem" parameterType="beta.function.order.dto.CartDTO" useGeneratedKeys="true" keyProperty="userCode">
        INSERT INTO game_cart
        (
            userCode,
            gameCode
        )
        VALUES
            (
                #{ userCode },
                #{ gameCode }
            )
    </insert>

    <update id="addItem" parameterType="beta.function.order.dto.CartDTO" useGeneratedKeys="true" keyProperty="userCode">
        UPDATE game_cart
        SET
        addCart = 'Y'
        WHERE gameCode = #{ gameCode } and userCode = #{ userCode }
    </update>

    <!--장바구니 게임 삭제-->
    <delete id="deleteCart" parameterType="beta.function.order.dto.CartDTO">
        DELETE
        FROM
            game_cart
        WHERE
            gameCode = #{ gameCode }
    </delete>

    <!--장바구니 전체 내역 삭제-->
    <delete id="deleteAllCart" parameterType="beta.function.order.dto.CartDTO">
<!--        DELETE-->
<!--        FROM-->
<!--            game_cart-->
<!--        WHERE-->
<!--            userCode = #{ userCode }-->

        UPDATE game_order
        SET
        gamecheck = 'Y'
        WHERE userCode IN (select userCode from game_cart where userCode = #{ userCode });

    </delete>
</mapper>